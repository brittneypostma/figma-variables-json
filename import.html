<style>
  :root {
    --spacing: 0.8rem;
  }
  * {
    box-sizing: border-box;
  }
  body {
    background-color: var(--figma-color-bg);
    color: var(--figma-color-text);
    margin: 0;
    padding: var(--spacing);
  }
  html,
  body {
    height: 100%;
  }
  form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing);
    height: 100%;
  }
  button {
    appearance: none;
    border-radius: 4px;
    padding: var(--spacing);
  }
  input,
  textarea {
    font-family: Andale Mono, monospace;
    font-size: 0.9rem;
    padding: var(--spacing);
  }
  textarea {
    flex: 1;
    white-space: pre;
  }
  form > * {
    display: block;
    width: 100%;
  }
  button {
    background-color: var(--figma-color-bg-brand);
    border: none;
    color: var(--figma-color-text-onbrand);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
      sans-serif;
    font-weight: bold;
  }
  input,
  textarea {
    background-color: var(--figma-color-bg-secondary);
    color: var(--figma-color-text-secondary);
    border: 2px solid var(--figma-color-border);
  }
  input:focus,
  textarea:focus {
    border-color: var(--figma-color-border-selected);
    outline: none;
  }
</style>
<form>
  <label for="collectionSelect"></label>
  <select name="collectionSelect" id="collectionSelect">
    <option value="new">Create a New Collection</option>
  </select>

  <input
    placeholder="Collection Name"
    required
    type="text"
    value=""
    id="collectionInput"
  />

  <label for="modeSelect"></label>
  <select name="modeSelect" id="modeSelect">
    <option value="new">Create a New Mode</option>
  </select>

  <input placeholder="Mode Name" required type="text" value="" id="modeInput" />

  <textarea required placeholder="Tokens JSON">
{
  "color": {
    "grouptyped": {
      "$type": "color",
      "brown": { "$value": "#a2845e" },
      "danger-deep": { "$value": "{color.valuetyped.danger}" }
    },
    "valuetyped": {
      "red": {
        "$value": "{color.deep.deep.deep.deep.deep}"
      },
      "danger": { "$value": "{color.valuetyped.red}" }
    },
    "deep": {"deep": {"deep": {"deep": {"deep": {"$type": "color", "$value": "#FF0000" }}}}}
  },
  "spacing": {
    "$type": "number",
    "some numbers": {
      "spacer0": {"$value": 0},
      "spacerXs": {"$value": 4},
      "spacerS": {"$value": 8},
      "spacerM": {"$value": 16},
      "spacerX": {"$value": 24},
      "spacerXl": {"$value": 32},
      "spacerXxl": {"$value": 40},
      "spacex": {
        "funniness": {"$value": 0},
        "cleverness": {"$value": 1}
      }
    }
  }
}
</textarea
  >
  <button type="submit">Import Variables</button>
</form>

<script>
  const collections = {};
  const collectionSelect = document.querySelector("#collectionSelect");
  const collectionInput = document.querySelector("#collectionInput");
  const modeSelect = document.querySelector("#modeSelect");
  const newModeOption = document.createElement("option");
  const modeInput = document.querySelector("#modeInput");
  newModeOption.value = "new";
  newModeOption.text = "Create a New Mode";

  window.onmessage = (event) => {
    let message = event.data.pluginMessage;
    let collectionOptions = [];

    if (message.type === "LOAD_COLLECTIONS") {
      // TODO: update collection list when making changes
      for (let name in message.collections) {
        let collection = message.collections[name];
        collections[name] = collection;

        const newOption = document.createElement("option");
        newOption.value = name;
        newOption.text = name;
        newOption.dataset.id = collection.id;
        collectionOptions.push(newOption);
      }
    }

    collectionSelect.append(...collectionOptions);
  };

  function hideInputElement(inputElement, value) {
    inputElement.style.display = "none";
    // handle the case if it's an existing mode
    inputElement.value = value;
    // disable input
    inputElement.disabled = true;
  }

  function showInputElement(inputElement) {
    inputElement.style.display = "block";
    inputElement.disabled = false;
    inputElement.value = "";
  }

  function clearMode() {
    modeSelect.length = 0;
    modeSelect.append(newModeOption.cloneNode(true));
    showInputElement(modeInput);
  }

  function clearCollection() {
    collectionInput.focus();
    clearMode();
  }

  function handleCollectionChange(event) {
    // handle the case if it's a new Collection
    console.log(`Event: ${event.target.value}`);
    let currentCollection = collections[event.target.value];
    // enable input
    if (event.target.value === "new") {
      showInputElement(collectionInput);
      clearCollection();
    } else {
      hideInputElement(collectionInput, event.target.value);
      // load modes
      modeSelect.length = 0;
      modeSelect.append(newModeOption.cloneNode(true));
      const defaultModeId = currentCollection.defaultModeId;
      // load modes
      currentCollection.modes.forEach((element) => {
        let newOption = document.createElement("option");
        newOption.text = element.name;
        newOption.value = element.name;
        newOption.dataset.id = element.modeID;
        modeSelect.append(newOption);
        if (element.modeID === defaultModeId) {
          newOption.selected = true;
          newOption.text = `${element.name} (Default Mode)`;
          hideInputElement(modeInput, element.name);
        }
      });
    }
  }

  function handleModeChange(event) {
    // enable input
    if (event.target.value === "new") {
      showInputElement(modeInput);
      modeInput.focus();
    } else {
      hideInputElement(modeInput, event.target.value);
    }
  }

  collectionSelect.addEventListener("change", handleCollectionChange);
  modeSelect.addEventListener("change", handleModeChange);

  document.querySelector("form").addEventListener("submit", (e) => {
    const selectedCollection = {
      name: document.querySelector("#collectionInput").value.trim(),
      id: collectionSelect.selectedOptions
        ? collectionSelect.selectedOptions[0].dataset.id
        : null,
    };
    const selectedMode = {
      name: document.querySelector("#modeInput").value.trim(),
      id: modeSelect.selectedOptions
        ? modeSelect.selectedOptions[0].dataset.id
        : null,
    };
    const body = document.querySelector("textarea").value.trim();
    e.preventDefault();
    if (isValidJSON(body) && selectedCollection.name) {
      parent.postMessage(
        {
          pluginMessage: {
            selectedCollection,
            selectedMode,
            body,
            type: "IMPORT",
          },
        },
        "*"
      );
    } else {
      alert("Invalid filename or JSON");
    }
  });
  document.getElementById("export").addEventListener("click", () => {
    parent.postMessage({ pluginMessage: { type: "EXPORT" } }, "*");
  });

  function isValidJSON(body) {
    try {
      JSON.parse(body);
      return true;
    } catch (e) {
      return false;
    }
  }
</script>
